<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxury Hampers - Admin Panel</title>
    <!-- Using Tailwind CSS for rapid, clean styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple style overrides for a cleaner look */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .status-badge { padding: 4px 10px; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .status-pending { background-color: #fef9c3; color: #854d0e; }
        .status-shipped { background-color: #dbeafe; color: #1e40af; }
        .status-delivered { background-color: #dcfce7; color: #166534; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #1d4ed8; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="text-gray-800">

    <!-- Container for the entire application -->
    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">

        <!-- Login Section (Visible by default) -->
        <div id="login-section" class="w-full max-w-md bg-white p-8 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">Admin Panel Login</h1>
            <p class="text-center text-gray-500 mb-6">Access for authorized personnel only.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-300">Login</button>
            </form>
            <div id="login-error" class="mt-4 text-center text-red-600"></div>
        </div>

        <!-- Admin Dashboard (Hidden by default) -->
        <div id="dashboard-section" class="hidden w-full max-w-4xl bg-white p-8 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-2xl font-bold text-gray-800">Order Lookup</h1>
                <button id="logout-btn" class="text-sm text-blue-600 hover:underline">Logout</button>
            </div>

            <!-- Search Form -->
            <form id="search-form" class="mb-6">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Search by Order ID or Customer Email</label>
                <div class="flex">
                    <input type="search" id="search-input" placeholder="e.g., ORD-250907-A3K9B or customer@example.com" class="flex-grow px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700 transition duration-300">Search</button>
                </div>
            </form>

            <!-- Results Section -->
            <div id="results-section">
                <div id="loader" class="hidden justify-center items-center py-8"><div class="spinner"></div></div>
                <div id="results-message" class="text-center text-gray-500 py-8">Enter an Order ID or email to begin.</div>
                <div id="results-table" class="hidden">
                    <!-- Table will be rendered here by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- START: FIREBASE CONFIGURATION ---
        // IMPORTANT: Replace this with your actual Firebase project configuration.
        // This is the same config object from your `auth.js` file.
        const firebaseConfig = {
            apiKey: "AIzaSyBzU9YCpen0fJ12eGSnLeQGXsavSa9kX3w",
            authDomain: "luxury-hampers-app.firebaseapp.com",
            projectId: "luxury-hampers-app",
            storageBucket: "luxury-hampers-app.firebasestorage.app",
            messagingSenderId: "314612428903",
            appId: "1:314612428903:web:39c34c1d63e0aa818124c2"
        };
        // --- END: FIREBASE CONFIGURATION ---

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const db = firebase.firestore();

        // DOM Element References
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const loader = document.getElementById('loader');
        const resultsMessage = document.getElementById('results-message');
        const resultsTableContainer = document.getElementById('results-table');


        /**
         * Checks the current user's authentication state and verifies if they are an admin.
         */
        fbAuth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in, now check for admin privileges in Firestore.
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().isAdmin === true) {
                    // User is an admin, show the dashboard.
                    loginSection.classList.add('hidden');
                    dashboardSection.classList.remove('hidden');
                } else {
                    // User is not an admin, log them out and show an error.
                    await fbAuth.signOut();
                    loginError.textContent = 'Access Denied. You do not have admin privileges.';
                }
            } else {
                // User is signed out, show the login form.
                loginSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
            }
        });

        /**
         * Handles the admin login form submission.
         */
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await fbAuth.signInWithEmailAndPassword(email, password);
                // The onAuthStateChanged listener will handle showing the dashboard.
            } catch (error) {
                console.error('Admin Login Error:', error);
                loginError.textContent = 'Login failed. Please check your credentials.';
            }
        });

        /**
         * Handles logout button click.
         */
        logoutBtn.addEventListener('click', () => {
            fbAuth.signOut();
        });


        /**
         * Handles the order search form submission.
         */
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (!query) return;

            // Show loader and hide previous results/messages
            loader.classList.remove('hidden');
            resultsMessage.classList.add('hidden');
            resultsTableContainer.classList.add('hidden');
            resultsTableContainer.innerHTML = '';

            try {
                const currentUser = fbAuth.currentUser;
                if (!currentUser) throw new Error("Authentication error.");

                const token = await currentUser.getIdToken();

                // Determine if the search is for an email or order ID
                const isEmail = query.includes('@');
                const searchParam = isEmail ? `email=${encodeURIComponent(query)}` : `orderId=${encodeURIComponent(query)}`;
                
                const response = await fetch(`/api/find-order?${searchParam}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('No orders found for the given criteria.');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const orders = await response.json();
                renderResults(orders);

            } catch (error) {
                console.error('Order search failed:', error);
                resultsMessage.textContent = `Error: ${error.message}`;
                resultsMessage.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        });

        /**
         * Renders the fetched order data into a clean HTML table.
         * @param {Array<Object>} orders - An array of order objects.
         */
        function renderResults(orders) {
            if (!orders || orders.length === 0) {
                resultsMessage.textContent = 'No orders found matching your search.';
                resultsMessage.classList.remove('hidden');
                return;
            }

            // Create the table structure
            let tableHtml = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;

            // Populate table rows
            orders.forEach(order => {
                const orderDate = new Date(order.orderDate.seconds ? order.orderDate.toDate() : order.orderDate).toLocaleDateString();
                const customerName = order.customerName || 'N/A';
                const customerEmail = order.customerEmail || 'N/A';
                const statusClass = `status-${(order.status || 'pending').toLowerCase()}`;
                
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <div>${customerName}</div>
                            <div class="text-xs text-gray-500">${customerEmail}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${orderDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">£${order.totalAmount.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <span class="status-badge ${statusClass}">${order.status || 'Pending'}</span>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table></div>`;
            
            // Display the table
            resultsTableContainer.innerHTML = tableHtml;
            resultsTableContainer.classList.remove('hidden');
        }

    </script>
</body>
</html>
